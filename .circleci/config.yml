version: 2
jobs:
  build:
    machine:
      docker_layer_caching: true
    branches:
      only:
      - graphene
    working_directory: ~/go/src/github.com/quantadex/distributed_quanta_bridge
    environment:
      TEST_RESULTS: /tmp/test-results
    steps:
    - run: go get github.com/jstemmer/go-junit-report
    - run: go get -u github.com/tebeka/go2xunit
    - checkout
    - run:
        name: Install checkout requirements
        command: |
          curl -s https://packagecloud.io/install/repositories/github/git-lfs/script.deb.sh | sudo bash
          sudo apt-get install git-lfs
          git lfs install
    - run:
        name: Checkout binaries
        command: git lfs pull
    - run: tar xvf vendor.tar
    - run: ls -a
    - run: mkdir -p ~/go/src/github.com/quantadex/distributed_quanta_bridge/TEST_RESULTS
    - run:
        name: Install Docker Compose
        command: |
          curl -L https://github.com/docker/compose/releases/download/1.19.0/docker-compose-`uname -s`-`uname -m` > ~/docker-compose
          chmod +x ~/docker-compose
          sudo mv ~/docker-compose /usr/local/bin/docker-compose
    - run: cd blockchain && docker-compose up -d
#    - run: curl -v http://litecoind:19332
#    - run:
#        name: run_test
#        command: |
#          for name in common node registrar trust; do
#              echo "Testing $name..."
#              rm -f ./reports/report_$name.xml
#              2>&1 go test -v ./$name/... | tee gotest_$name.out
#              $WORKSPACE/bin/go2xunit -fail -input gotest_$name.out -output ./reports/report_$name.xml || :
#              echo
#          done
    - run: touch ~/go/src/github.com/quantadex/distributed_quanta_bridge/TEST_RESULTS/go-test.out
    - run: touch ~/go/src/github.com/quantadex/distributed_quanta_bridge/TEST_RESULTS/go-test-report.xml
    - run:
        name: Run unit tests
        command: |
          trap "go-junit-report <${TEST_RESULTS}/go-test.out > ${TEST_RESULTS}/go-test-report.xml" EXIT
          make test | tee ${TEST_RESULTS}/go-test.out

    - run: make # pull and build dependencies for the project


#    - store_test_results:
#        path: ./reports
#    - store_artifacts:
#        path: ./reports